<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%- title %></title>
    <link rel="stylesheet" type="text/css" href="/css/all.css" />
    <script src="/js/shop_cart/cookie.js"></script>
    <script
      src="https://kit.fontawesome.com/93e1c8f0af.js"
      crossorigin="anonymous"
    ></script>
    <script src="/js/shop_cart/jquery.js"></script>
  </head>

  <body>
    <div class="wrapper">
      <%- include("navbar.ejs") %>
      <table>
        <thead>
          <th colspan=""></th>
        </thead>
      </table>
      <!-- outline_class  oib oig oi  oir-->
      <div class="container">
        <div class="cart_content">
          <div class="row content_text">
            <div class="col-9" style="padding: 0">
              <div class="row cart_banner">
                <div class="col-12 top_link">
                  <ul class="cart-link">
                    <li><a href="/">首頁</a></li>
                    <li>
                      <a href="#">購物車</a>
                    </li>
                  </ul>
                </div>
                <div class="col-12 mid mb-3">
                  <h6 style="font-size: 1.2em; font-weight: 900">購物車</h6>
                </div>
                <div class="col-12 cart-step">
                  <ul class="fz-dark">
                    <li>
                      <span>1</span>
                      查看購物車
                    </li>
                    <li style="color: #000">
                      <span>2</span>
                      訂單確認
                    </li>
                    <li>
                      <span style="background-color: #000">3</span>
                      訂單完成
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-3"></div>
          </div>
          <div class="row content_text">
            <div class="col-9">
              <div class="row">
                <div class="col-12 text-center mb-3" >
                  <div ><img src="/img/shop_cart/Finish.png" alt=""></div>
                </div>
                <div class="col-12 text-center mb-2" >
                  <p >已經收到您的訂單</p>
                </div>
                <div class="col-12 text-center mb-3" >
                  <h6>訂單編號 : <span id="newOrder"></span></h6>
                </div>
                <div class="col-12 text-center mb-3" >
                  <p style="color: red; font-size: 0.6em;">請拍照或儲存以便日後查詢</p>
                </div>
                <div class="col-12">
                  <div
                    style="border-radius: 5px"
                    class="d-flex bg-gary px-4 py-2 align-items-center mb-4"
                  >
                    <h6 class="flex-grow-1 fw-600" >訂單資訊</h6>
                  </div>
                  <div  >
                    <h6>收件人 : <span id="name"></span></h6>
                    <h6>地址 : <span id="city"></span> <span id="address"></span></h6>
                    <h6>手機號碼 : <span id="phone"></span></h6>
                    <h6>信箱 : <span id="email"></span></h6>
                  </div>
                  <div>
                    <%- cart %>
                  </div>
                </div>
                
              </div>
            </div>
              <div class="col-3" style="padding: 0">
                <div class="div cart_Order">
                  <div style="text-align: center">
                    <p>訂單確認</p>
                  </div>
                  <div class="py-2">
                    <p>
                      <b>總計商品件數:</b>
                      <span class="float-right"
                        ><span id="total_count">0</span> 件</span
                      >
                    </p>
                    <p>
                      <b>小計:</b
                      ><span class="float-right"
                        >NT$<span id="total_price">0</span></span
                      >
                    </p>
                    <p>
                      <b>運費:</b
                      ><span class="float-right">NT$<span>0</span></span>
                    </p>
                  </div>
                  <div class="py-3">
                    只差NT$ <span>0</span>，即可享有免費標準運送。
                  </div>
                  <div class="pt-2 mb-4">
                    <p>
                      <b>總額:</b
                      ><span class="float-right">NT$<span>0</span></span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="push"></div>
    </div>
    <footer class="footer"><%- include("footer.ejs") %></footer>
    <script>
      $(document).ready(function () {
        var url = location.href;
         if(url.indexOf("?") != -1){
          var arr1 = url.split("?");
          var arr2 = arr1[1].split("&");
          var arr3 = arr2[1].split("=");
          
          let o_name =decodeURI(arr2[0].split("=")[1]) ;
          let o_city = arr2[1].split("=")[1];
          let o_address =decodeURI(arr2[2].split("=")[1]) ;
          let o_phone = arr2[3].split("=")[1];
          let o_email =arr2[4].split("=")[1].replace("%40","@") ;
          let o_List = arr2[10].split("=")[1];

          $("#newOrder").html(o_List);
          $("#name").html(o_name);
          $("#city").html(o_city);
          $("#address").html(o_address);
          $("#phone").html(o_phone);
          $("#email").html(o_email);

          

          
         }





        function serializeToJSON(data) {
          values = {};
          for (index in data) {
            //把data的name跟value結合並放進values的物件裡
            values[data[index].name] = data[index].value;
          }
          return JSON.stringify(values);
        }

        $('#orderList input[name="name"]').on("input", function () {
          if (!$('#orderList input[name="name"]').val() == "") {
            $('#orderList input[name="name"]').addClass("inp_right");
            $("#nameErr").css("visibility", "hidden");
          }
        });
        $('#orderList input[name="city"]').on("input", function () {
          if (!$('#orderList input[name="city"]').val() == "") {
            $('#orderList input[name="city"]').addClass("inp_right");
            $("#addressErr").css("visibility", "hidden");
          }
        });
        $('#orderList input[name="address"]').on("input", function () {
          if (!$('#orderList input[name="address"]').val() == "") {
            $('#orderList input[name="address"]').addClass("inp_right");
            $("#addressErr").css("visibility", "hidden");
          }
        });

        $('#orderList input[name="phone"]').on("input", function () {
          if (!$('#orderList input[name="phone"]').val() == "") {
            $('#orderList input[name="phone"]').addClass("inp_right");
            $("#phoneErr").css("visibility", "hidden");
          }
        });
        $('#orderList input[name="email"]').on("input", function () {
          if (!$('#orderList input[name="email"]').val() == "") {
            $('#orderList input[name="email"]').addClass("inp_right");
            $("#emailErr").css("visibility", "hidden");
          }
        });

        function checkInputInfo() {
          var name = $('#orderList input[name="name"]').val();
          var city = $('#orderList input[name="city"]').val();
          var address = $('#orderList input[name="address"]').val();
          var phone = $('#orderList input[name="phone"]').val();
          var email = $('#orderList input[name="email"]').val();

          var cityFormat = /(^[1-9]d{3})||(^[1-9]d{5})/;
          var phoneFormat = /^09[0-9]{8}$/;
          var emailFormat =
            /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
          var checkOrder = true;

          if (name == null || name == "") {
            $('#orderList input[name="name"]').addClass("fpop_inperro");
            $("#nameErr").css("visibility", "visible");
            checkOrder = false;
          }
          if (city == null || city == "") {
            $('#orderList input[name="city"]').addClass("fpop_inperro");
            $("#addressErr").css("visibility", "visible");
            checkOrder = false;
          } else if (!cityFormat.test(city)) {
            $('#orderList input[name="city"]').addClass("fpop_inperro");
            $('#orderList input[name="city"]').removeClass("inp_right");
            $("#addressErr").css("visibility", "hidden");
            $("#addressErr2").css("visibility", "visible");
            checkOrder = false;
          }
          if (address == null || address == "") {
            $('#orderList input[name="address"]').addClass("fpop_inperro");
            $("#addressErr").css("visibility", "visible");
            checkOrder = false;
          }
          if (phone == null || phone == "") {
            $('#orderList input[name="phone"]').addClass("fpop_inperro");
            $("#phoneErr").css("visibility", "visible");
            checkOrder = false;
          } else if (!phoneFormat.test(phone)) {
            $('#orderList input[name="phone"]').addClass("fpop_inperro");
            $('#orderList input[name="phone"]').removeClass("inp_right");
            $("#phoneErr").css("visibility", "hidden");
            $("#phoneErr2").css("visibility", "visible");
            checkOrder = false;
          }

          if (email == null || email == "") {
            $('#orderList input[name="email"]').addClass("fpop_inperro");
            $("#emailErr").css("visibility", "visible");
            checkOrder = false;
          } else if (!emailFormat.test(email)) {
            $('#orderList input[name="email"]').addClass("fpop_inperro");
            $('#orderList input[name="email"]').removeClass("inp_right");
            $("#emailErr").css("visibility", "hidden");
            $("#emailErr2").css("visibility", "visible");
            checkOrder = false;
          }

          return checkOrder;
        }

        $("#cart-submit").on("click", function () {
          if (!checkInputInfo()) {
            let date = new Date();

            console.log(date);

            alert("請填寫資料");
            return false;
          } else if (!$('#orderList input[name="agree"]').prop("checked")) {
            alert("請勾選同意條款");
            return false;
          } else {
            var data = $("#orderList").serializeArray();
            JSONData = serializeToJSON(data);
            console.log(JSONData);

            $.ajax({
              url: "/home/shop_cart/orderCheck/add",
              type: "POST",
              contentType: "application/json; charset=utf-8",
              data: JSONData,
              success: function (res) {
                var res = JSON.parse(res);

                if (res.errno === 1) {
                  alert("新增成功");
                } else if (res.errno === 0) {
                  alert("新增失敗");
                }
              },
              error: function () {
                alert("系統錯誤");
                return false;
              },
            });
          }
        });
      });
    </script>

    <script src="/js/shop_cart/owl.carousel.js"></script>
    <script src="/js/shop_cart/server.js"></script>
    <script src="/js/shop_cart/cart.js"></script>
    <script src="/js/shop_cart/owl.js"></script>
    <script src="/js/shop_cart/bootstrap.js"></script>
  </body>
</html>
